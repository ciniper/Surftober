<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surftober Web (Demo)</title>
  <link rel="manifest" href="./manifest.webmanifest?v=5">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%8F%84%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="./styles.css?v=5" />
  <meta name="theme-color" content="#0b3d91" />
  <script>
  // Redirect to landing page if not coming from auth flow or already in app
  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromAuth = sessionStorage.getItem('surftober_authenticated');
    
    // Check for any Supabase auth token in localStorage
    let hasSession = false;
    try {
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('supabase') && key.includes('auth')) {
          const val = localStorage.getItem(key);
          if (val && val.length > 10) {
            hasSession = true;
            break;
          }
        }
      }
    } catch (e) {}
    
    // If no auth session and not coming from registration/sign-in, redirect to landing
    if (!fromAuth && !hasSession && !urlParams.has('mode')) {
      window.location.replace('./landing.html');
      return;
    }
    
    // Clear the auth flag after checking
    if (fromAuth) {
      sessionStorage.removeItem('surftober_authenticated');
    }
  })();
  </script>
</head>
  <script>
  // Runtime error overlay + one-time PWA rescue to clear stale SW/caches
  (function(){
    // Error overlay
    function ensureOverlay(){
      var el = document.getElementById('err-overlay');
      if (el) return el;
      el = document.createElement('div');
      el.id = 'err-overlay';
      el.style.cssText = 'position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,.85);color:#fff;font:12px/1.4 system-ui,monospace;padding:16px;overflow:auto;';
      var close = document.createElement('button');
      close.textContent = '‚úï';
      close.style.cssText = 'position:absolute;top:8px;right:8px;background:#333;color:#fff;border:1px solid #666;padding:4px 8px;border-radius:4px;cursor:pointer;';
      close.onclick = function(){ el.remove(); };
      el.appendChild(close);
      var pre = document.createElement('pre');
      pre.id = 'err-overlay-pre';
      pre.style.whiteSpace = 'pre-wrap';
      el.appendChild(pre);
      document.documentElement.appendChild(el);
      return el;
    }
    function showError(msg){
      try{
        var el = ensureOverlay();
        var pre = document.getElementById('err-overlay-pre');
        pre.textContent = String(msg || '').slice(0, 100000);
        console.error('[RUNTIME ERROR]', msg);
      }catch(_){ /* noop */ }
    }
    window.addEventListener('error', function(e){
      var info = (e && e.message ? e.message : 'Script error') + (e && e.filename ? ('\n' + e.filename + ':' + e.lineno + ':' + e.colno) : '');
      if (e && e.error && e.error.stack) info += '\n' + e.error.stack;
      showError(info);
    });
    window.addEventListener('unhandledrejection', function(e){
      var reason = e && e.reason ? e.reason : 'unknown';
      var text = 'Unhandled promise rejection: ' + (reason && reason.message ? reason.message : String(reason));
      if (reason && reason.stack) text += '\n' + reason.stack;
      showError(text);
    });

    // One-time SW/cache rescue to break out of stale SW
    try {
      if (!sessionStorage.getItem('pwa_rescue_done')) {
        sessionStorage.setItem('pwa_rescue_done', '1');
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function(regs){
            return Promise.all(regs.map(function(r){ return r.unregister().catch(function(){}); }));
          }).then(function(){
            if (window.caches && caches.keys) {
              return caches.keys().then(function(names){
                return Promise.all(names.map(function(n){ return caches.delete(n); }));
              });
            }
          }).finally(function(){
            location.reload();
          });
        }
      }
    } catch (_) {}
  })();
  </script>

<body>
  <header class="app-header">
    <div class="brand">üèÑ Surftober</div>
    <nav class="tabs">
      <a href="#log" class="tab-link" data-tab="log">Log</a>
      <a href="#me" class="tab-link" data-tab="me">My Stats</a>
      <a href="#leaderboard" class="tab-link" data-tab="leaderboard">Leaderboard</a>
      <a href="#awards" class="tab-link" data-tab="awards">Awards</a>
      <a href="#admin" id="tab-admin-link" class="tab-link" data-tab="admin">Admin</a>
      <a href="#account" class="tab-link" data-tab="account">Account</a>
    </nav>
  </header>

  <main id="app">
    <!-- Log Page -->
    <section id="page-log" class="page">
      <h2>Quick Log</h2>
      <form id="log-form">
        <div class="grid">
          <label>
            Name
            <input required list="user-list" id="log-user" placeholder="Your name" />
            <datalist id="user-list"></datalist>
          </label>
          <label>
            Date
            <input required type="date" id="log-date" />
          </label>
          <label>
            Type
            <select id="log-type">
              <option value="surf">Surf</option>
              <option value="windsport">Windsport (Kite/Wing)</option>
              <option value="swim">Swim/Dip/Bodysurf</option>
              <option value="other">Other (Kayak/In-water Photo/Boogie)</option>
              <option value="cleanup">Cleanup</option>
            </select>
          </label>
          <label>
            Duration
            <div class="duration-inputs">
              <input type="number" id="log-duration-h" min="0" max="24" value="1" aria-label="Hours" /> h
              <input type="number" id="log-duration-m" min="0" max="59" step="1" value="0" aria-label="Minutes" /> m
            </div>
          </label>
          <label>
            Location
            <input list="location-list" id="log-location" placeholder="e.g., OB - Lawton" />
            <datalist id="location-list"></datalist>
          </label>
          <label id="field-craft">
            Surf craft
            <input list="board-list" id="log-board" placeholder="e.g., 6'1 Phantom" />
            <datalist id="board-list"></datalist>
          </label>
        </div>
        <div class="grid">
          <label class="checkbox">
            <input type="checkbox" id="log-no-wetsuit" /> No Wetsuit (double minutes)
          </label>
          <label class="checkbox">
            <input type="checkbox" id="log-costume" /> Costume Bonus (+1h once)
          </label>
        </div>
        <label>
          Notes
          <textarea id="log-notes" rows="3" placeholder="Short journal‚Ä¶"></textarea>
        </label>
        <!-- Voice note controls temporarily removed; see feature/voice-notes-wip branch -->

        <div class="actions">
          <button type="submit" id="btn-submit">Add Entry</button>
          <button type="button" id="btn-cancel-edit" class="warn" style="display:none">Cancel Edit</button>
        </div>
      </form>

      <h3>Recent Entries</h3>
      <div id="recent-entries" class="card-list"></div>
    </section>

    <!-- My Stats Page -->
    <section id="page-me" class="page">
      <h2>My Stats</h2>
      <div class="filters">
        <label> Name
          <input list="user-list" id="me-user" placeholder="Your name" />
        </label>
        <label> Year
          <input type="number" id="me-year" value="2025" />
        </label>
        <label> Month
          <select id="me-month">
            <option value="10" selected>October (Surftober)</option>
            <option value="0">All Months</option>
          </select>
        </label>
      </div>
      <div id="me-summary" class="cards"></div>
      <h3>Sessions</h3>
      <div id="me-sessions" class="table"></div>
    </section>

    <!-- Leaderboard Page -->
    <section id="page-leaderboard" class="page">
      <h2>Leaderboard</h2>
      <div class="filters">
        <label> Year <input type="number" id="lb-year" value="2025" /></label>
        <label> Month
          <select id="lb-month">
            <option value="10" selected>October</option>
            <option value="0">All</option>
          </select>
        </label>
      </div>
      <div id="leaderboard" class="table"></div>
      <p class="hint">Medal thresholds (demo): Gold ‚â• 40h, Silver ‚â• 30h, Bronze ‚â• 25h, Participant ‚â• 10h.</p>
    </section>

    <!-- Awards Page -->
    <section id="page-awards" class="page">
      <h2>Awards</h2>
      <div class="filters">
        <label> Year <input type="number" id="aw-year" value="2025" /></label>
        <label> Month
          <select id="aw-month">
            <option value="10" selected>October</option>
            <option value="0">All</option>
          </select>
        </label>
        <button id="btn-compute-awards">Compute Awards</button>
        <button id="btn-export-awards">Export JSON</button>
        <button id="btn-awards-slides">Open Print Slides</button>
      </div>
      <div id="awards" class="cards"></div>
    </section>

    <!-- Admin Page -->
    <section id="page-admin" class="page">
      <h2>Admin</h2>
      <div class="cards">
        <div class="card">
          <h3>Import CSV</h3>
          <p>Columns (header expected): user,date(YYYY-MM-DD),type,duration(HH:MM),location,board,notes,no_wetsuit(0/1),costume(0/1),cleanup_items(int)</p>
          <input type="file" id="csv-file" accept=".csv,text/csv" />
        </div>
        <div class="card">
          <h3>Export</h3>
          <button id="btn-export-csv">Export Sessions CSV</button>
        </div>
        <div class="card">
          <h3>Seed Data (local demo only)</h3>
          <button id="btn-load-sample">Load Sample Dataset</button>
          <button id="btn-clear">Clear All Data</button>
        </div>
        <div class="card">
          <h3>Factory Reset</h3>
          <p>Signs out, clears local data and caches, and reloads.</p>
          <button id="btn-factory-reset" class="warn">Factory Reset (This device)</button>
        <div class="card" id="admin-users-card">
          <h3>Registered Users</h3>
          <p>Admins only ‚Äî list of emails and display names.</p>
          <div class="actions">
            <button id="btn-list-users">List Users</button>
          </div>
          <div id="admin-users" class="table"></div>
        </div>

        </div>
        <div class="card">
          <h3>Nuclear Wipe</h3>
          <p>Deletes ALL users and ALL logged data for this project. Requires the backend Edge Function to be deployed. This cannot be undone.</p>
          <button id="btn-nuclear-wipe" class="warn">Nuclear Wipe (All users + data)</button>
        </div>
        <div class="card">
          <h3>Status</h3>
          <pre id="status"></pre>
        </div>
      </div>
    </section>

    <!-- Account Page -->
    <section id="page-account" class="page">
      <h2>Account</h2>
      <div class="cards">
        <div class="card">
          <h3>Profile</h3>
          <div class="hint" id="account-status"></div>
          <div class="grid">
            <label>Display Name
              <input type="text" id="display-name" placeholder="Your public name" />
            </label>
            <label>Target Hours Goal
              <input type="text" id="profile-target-hours" placeholder="e.g., 40 hours" />
            </label>
            <label>Charitable Contribution Commitment
              <input type="text" id="profile-charity" placeholder="e.g., $100" />
            </label>
            <label>Sponsor Match
              <input type="text" id="profile-sponsor" placeholder="e.g., Company XYZ" />
            </label>
            <label>Location Based
              <input type="text" id="profile-location" placeholder="e.g., Outer Sunset" />
            </label>
            <label>WhatsApp Phone
              <input type="text" id="profile-whatsapp" placeholder="e.g., 916-622-6075" />
            </label>
            <label>Fun Comment
              <textarea id="profile-fun-comment" rows="2" placeholder="Your opening comment"></textarea>
            </label>
            <label>Additional Comments
              <textarea id="profile-comments" rows="2" placeholder="Questions or comments"></textarea>
            </label>
          </div>
          <div class="actions">
            <button id="btn-save-profile">Save Profile</button>
            <button id="btn-signout" class="warn" onclick="console.log('[INLINE] Sign out clicked'); if(window.sb && window.sb.auth) { window.sb.auth.signOut().then(() => { sessionStorage.clear(); Object.keys(localStorage).forEach(k => { if(k.includes('supabase')) localStorage.removeItem(k); }); window.location.replace('./landing.html'); }); } else { window.location.replace('./landing.html'); }">Sign Out</button>
            <button id="btn-delete-cloud" class="warn">Delete My Cloud Data</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <span>Surftober Demo ¬∑ PWA-ready <span id="live-status" class="live" style="display:none">‚Ä¢ LIVE</span></span>
    <span id="sw-status"></span>
  </footer>

  <div class="toast-container" id="toast-container" aria-live="polite"></div>

  <script src="./awards.js?v=5"></script>
  <script type="module" src="./app.js?v=9"></script>
</body>
</html>
